<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>作品集 | xaDGitHub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --bg:#0f1216; --card:#141a21; --text:#e8edf2; --muted:#9aa7b1; --accent:#5ac8fa; --border:#24303a; }
    * { box-sizing: border-box; }
    body {
      margin: 0; color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 20% -10%, #1b2230 0%, var(--bg) 40%) no-repeat, var(--bg);
    }
    header { max-width: 1200px; margin: 40px auto 24px; padding: 0 20px; }
    h1 { margin: 0 0 8px; font-size: 28px; }
    .sub { color: var(--muted); font-size: 14px; }
    .toolbar { display:flex; gap:8px; align-items:center; margin-top:12px; }
    .btn { background: linear-gradient(180deg, #1b2330, var(--card)); border:1px solid var(--border); color:var(--text);
      border-radius:10px; padding:10px 14px; font-size:14px; cursor:pointer; text-decoration:none; }
    .btn:hover { border-color:#334355; }

    .grid { max-width:1200px; margin:12px auto 40px; padding:0 20px; display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:16px; }
    .card {
      position:relative; overflow:hidden; border-radius:16px;
      background: linear-gradient(180deg, #18202a, var(--card));
      border:1px solid var(--border); box-shadow:0 8px 24px rgba(0,0,0,.25);
      transition: transform .2s ease, border-color .2s ease; cursor:pointer; min-height:160px;
    }
    .card:hover { transform: translateY(-2px); border-color:#38506a; }
    .card .name { position:absolute; left:14px; bottom:14px; right:14px; font-weight:600; font-size:16px; }
    .card .meta { position:absolute; left:14px; top:12px; font-size:12px; color:var(--muted); }

    .gallery { max-width:1200px; margin:12px auto 60px; padding:0 20px; }
    .breadcrumbs { display:flex; align-items:center; gap:8px; color:var(--muted); font-size:14px; margin-bottom:12px; }
    .breadcrumbs a { color:#5ac8fa; text-decoration:none; }
    .folder-title { font-size:20px; font-weight:700; margin:8px 0 16px; }
    .thumbs { display:grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap:12px; }
    .thumb { position:relative; border-radius:12px; overflow:hidden; border:1px solid var(--border); background:#0c0f14; cursor:pointer; }
    .thumb img { width:100%; height:160px; object-fit:cover; display:block; background:#0c0f14; }
    .thumb .label { position:absolute; left:8px; bottom:8px; right:8px; font-size:12px; color:var(--muted); text-shadow:0 1px 4px rgba(0,0,0,.6); }
    .thumb:hover { border-color:#3a5068; }
    .empty { color:var(--muted); padding:20px; border:1px dashed var(--border); border-radius:12px; background:#11161d; }

    /* Lightbox with zoom/pan */
    .lightbox { position:fixed; inset:0; background:rgba(0,0,0,.92); display:none; z-index:1000; }
    .lightbox.open { display:block; }
    .lb-toolbar {
      position:fixed; top:12px; left:50%; transform:translateX(-50%);
      display:flex; gap:8px; background:rgba(20,24,30,.78);
      border:1px solid var(--border); border-radius:12px; padding:6px;
      backdrop-filter: blur(6px);
      z-index: 1002; /* 高于舞台和图片 */
      pointer-events: auto;
    }
    .lb-btn { background:transparent; color:#e8edf2; border:1px solid var(--border); border-radius:8px; padding:8px 10px; cursor:pointer; font-size:14px; }
    .lb-btn:hover { border-color:#3a5068; }

    /* 舞台避开工具栏高度，防止遮挡和错误适配 */
    .lb-stage {
      position:absolute; left:0; right:0; bottom:0; top:64px; /* 工具栏约52px+间距，留64px安全区 */
      display:flex; align-items:center; justify-content:center; overflow:hidden; cursor:grab;
      z-index: 1001; /* 低于工具栏 */
    }
    .lb-stage.grabbing { cursor:grabbing; }
    .lb-img {
      will-change: transform; user-select:none; -webkit-user-drag:none;
      transform-origin: 0 0; /* 使用左上原点 + 平移，避免某些浏览器中心原点抖动 */
      display:block; max-width:none; max-height:none; /* 避免浏览器对大图做额外限制 */
    }
    .lb-hint { position:fixed; bottom:16px; left:50%; transform:translateX(-50%); color:#c8d1d9; font-size:12px; opacity:.85; z-index:1002; }
  </style>
</head>
<body>
  <header>
    <h1>我的前端作品集</h1>
    <div class="sub">点击各作品文件夹查看预览，图片支持放大缩小与拖拽移动。</div>
    <div class="toolbar">
      <button class="btn" id="backBtn" style="display:none">← 返回文件夹列表</button>
      <a class="btn" target="_blank" href="https://github.com/xaDGitHub/works">仓库</a>
    </div>
  </header>

  <section id="folderGrid" class="grid" aria-live="polite"></section>

  <section id="gallery" class="gallery" style="display:none">
    <div class="breadcrumbs"><a href="#" id="crumbHome">首页</a> / <span id="crumbFolder"></span></div>
    <div class="folder-title" id="galleryTitle"></div>
    <div class="thumbs" id="thumbs"></div>
  </section>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" role="dialog" aria-modal="true">
    <div class="lb-toolbar">
      <button class="lb-btn" id="btnZoomIn">＋ 放大</button>
      <button class="lb-btn" id="btnZoomOut">－ 缩小</button>
      <button class="lb-btn" id="btnFit">适配屏幕</button>
      <button class="lb-btn" id="btn100">100%</button>
      <button class="lb-btn" id="btnClose">关闭</button>
    </div>
    <div class="lb-stage" id="lbStage">
      <img id="lbImg" class="lb-img" alt="预览图"/>
    </div>
    <div class="lb-hint">提示：滚轮缩放，按住拖动，双击切换适配/100%，Esc 关闭</div>
  </div>

<script>
(function(){
  const owner = 'xaDGitHub';
  const repo  = 'works';
  const branch = 'main'; // 若默认分支是 master，请改为 'master'

  const apiBase = `https://api.github.com/repos/${owner}/${repo}/contents`;
  const cdnBase = `https://cdn.jsdelivr.net/gh/${owner}/${repo}@${branch}`;

  // 缩略图代理（更快）
  function thumbUrl(rawUrl, w=400) {
    const enc = encodeURIComponent(rawUrl);
    return `https://images.weserv.nl/?url=${enc}&w=${w}&q=85&il`;
  }

  const folderGrid = document.getElementById('folderGrid');
  const gallery = document.getElementById('gallery');
  const thumbs = document.getElementById('thumbs');
  const galleryTitle = document.getElementById('galleryTitle');
  const crumbFolder = document.getElementById('crumbFolder');
  const backBtn = document.getElementById('backBtn');
  const crumbHome = document.getElementById('crumbHome');

  const lightbox = document.getElementById('lightbox');
  const lbStage = document.getElementById('lbStage');
  const lbImg = document.getElementById('lbImg');
  const btnClose = document.getElementById('btnClose');
  const btnZoomIn = document.getElementById('btnZoomIn');
  const btnZoomOut = document.getElementById('btnZoomOut');
  const btnFit = document.getElementById('btnFit');
  const btn100 = document.getElementById('btn100');

  const IMG_EXT = ['.jpg','.jpeg','.png','.webp','.gif','.avif'];
  function extOf(name){ const i=name.lastIndexOf('.'); return i>=0?name.slice(i).toLowerCase():''; }
  function isImg(name){ return IMG_EXT.includes(extOf(name)); }
  function cdnUrl(path){ const clean = path.replace(/^\/+/, ''); return `${cdnBase}/${clean}`; }

  async function fetchJSON(url) {
    const res = await fetch(url, { headers: { 'Accept':'application/vnd.github+json' } });
    if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return res.json();
  }

  async function loadFolders() {
    folderGrid.innerHTML = '';
    gallery.style.display = 'none';
    backBtn.style.display = 'none';
    try {
      const items = await fetchJSON(apiBase);
      const dirs = items.filter(x => x.type === 'dir');
      if (!dirs.length) {
        folderGrid.innerHTML = `<div class="empty">根目录未检测到文件夹，请在仓库根目录创建作品文件夹。</div>`;
        return;
      }
      dirs.forEach(d => {
        const card = document.createElement('div');
        card.className = 'card';
        card.setAttribute('role','button');
        card.setAttribute('aria-label', `打开 ${d.name} 文件夹`);
        card.innerHTML = `<div class="meta">文件夹</div><div class="name">${d.name}</div>`;
        card.addEventListener('click', () => openFolder(d.path, d.name));
        folderGrid.appendChild(card);
      });
    } catch(e) {
      folderGrid.innerHTML = `<div class="empty">加载文件夹失败：${e.message}</div>`;
    }
  }

  async function openFolder(path, name) {
    gallery.style.display = 'block';
    backBtn.style.display = 'inline-block';
    galleryTitle.textContent = name;
    crumbFolder.textContent = name;
    thumbs.innerHTML = '';
    try {
      const children = await fetchJSON(`${apiBase}/${encodeURIComponent(name)}`);
      const assets = children.filter(x => x.type === 'file' && isImg(x.name));
      if (!assets.length) {
        thumbs.innerHTML = `<div class="empty">该文件夹内未检测到图片文件。</div>`;
        return;
      }
      assets.forEach(file => {
        const card = document.createElement('div');
        card.className = 'thumb';
        const full = cdnUrl(file.path);
        const img = document.createElement('img');
        img.loading = 'lazy';
        img.alt = file.name;
        img.src = thumbUrl(full, 400);
        img.srcset = `${thumbUrl(full, 300)} 300w, ${thumbUrl(full, 600)} 600w, ${thumbUrl(full, 900)} 900w`;
        img.sizes = "(max-width: 600px) 45vw, 200px";
        img.dataset.full = full;
        img.addEventListener('click', () => openLightbox(img.dataset.full, file.name));
        const label = document.createElement('div');
        label.className = 'label';
        label.textContent = file.name;
        card.appendChild(img); card.appendChild(label);
        thumbs.appendChild(card);
      });
    } catch(e) {
      thumbs.innerHTML = `<div class="empty">加载作品失败：${e.message}</div>`;
    }
  }

  // Lightbox state
  let state = {
    imgW: 0, imgH: 0,
    stageW: 0, stageH: 0,
    scale: 1, fitScale: 1, tx: 0, ty: 0,
    minScale: 0.25, maxScale: 8
  };
  function applyTransform() {
    lbImg.style.transform = `translate3d(${state.tx}px, ${state.ty}px, 0) scale(${state.scale})`;
  }
  function computeStageWH() {
    state.stageW = lbStage.clientWidth;
    state.stageH = lbStage.clientHeight; // 已避开工具栏高度
  }
  function computeFitScale() {
    computeStageWH();
    if (!state.imgW || !state.imgH) return 1;
    return Math.min(state.stageW / state.imgW, state.stageH / state.imgH);
  }
  function centerAtScale(scale) {
    computeStageWH();
    state.tx = (state.stageW - state.imgW * scale) / 2;
    state.ty = (state.stageH - state.imgH * scale) / 2;
  }
  function clampScale(sc) {
    const min = state.fitScale * state.minScale;
    const max = Math.max(state.fitScale * state.maxScale, 1.0);
    return Math.min(max, Math.max(min, sc));
  }

  function openLightbox(src, alt) {
    lightbox.classList.add('open');
    // 先清零，避免上一次状态影响
    state = { imgW:0,imgH:0,stageW:0,stageH:0,scale:1,fitScale:1,tx:0,ty:0,minScale:0.25,maxScale:8 };
    lbImg.style.transform = 'none';
    lbImg.src = ''; // 先清空，随后设置
    lbImg.alt = alt || '预览图';

    // 先等待容器布局完成，再加载图片，避免长图适配错误
    requestAnimationFrame(() => {
      lbImg.src = src;
      // 使用 decode() 确保图片像素尺寸可用
      if ('decode' in lbImg) {
        lbImg.decode().then(initImage).catch(() => lbImg.onload = initImage);
      } else {
        lbImg.onload = initImage;
      }
      lbImg.onerror = () => {
        // 兜底提示
        alert('图片加载失败，请稍后重试。');
        closeLightbox();
      };
    });
  }

  function initImage() {
    state.imgW = lbImg.naturalWidth;
    state.imgH = lbImg.naturalHeight;
    // 对极长图/极宽图都正常适配
    state.fitScale = computeFitScale();
    state.scale = state.fitScale;
    centerAtScale(state.scale);
    applyTransform();
  }

  function closeLightbox() {
    lightbox.classList.remove('open');
    lbImg.src = '';
  }

  // 缩放（以鼠标位置为中心）
  lbStage.addEventListener('wheel', (e) => {
    if (!lightbox.classList.contains('open')) return;
    e.preventDefault();
    const rect = lbStage.getBoundingClientRect();
    const mx = e.clientX - rect.left - state.tx;
    const my = e.clientY - rect.top  - state.ty;
    const delta = -e.deltaY;
    const factor = Math.exp(delta * 0.0015);
    const newScale = clampScale(state.scale * factor);
    const ratio = newScale / state.scale;
    state.tx = e.clientX - rect.left - mx * ratio;
    state.ty = e.clientY - rect.top  - my * ratio;
    state.scale = newScale;
    applyTransform();
  }, { passive:false });

  // 拖拽平移（鼠标）
  let dragging = false, lastX=0, lastY=0;
  lbStage.addEventListener('mousedown', (e) => {
    if (!lightbox.classList.contains('open')) return;
    dragging = true; lastX = e.clientX; lastY = e.clientY;
    lbStage.classList.add('grabbing');
  });
  window.addEventListener('mousemove', (e) => {
    if (!dragging) return;
    const dx = e.clientX - lastX, dy = e.clientY - lastY;
    lastX = e.clientX; lastY = e.clientY;
    state.tx += dx; state.ty += dy;
    applyTransform();
  });
  window.addEventListener('mouseup', () => { dragging = false; lbStage.classList.remove('grabbing'); });

  // 触控：单指拖拽、双指缩放
  let touchMode = { active:false, startDist:0, startScale:1, startTx:0, startTy:0, midX:0, midY:0 };
  function dist(p1, p2){ const dx=p1.clientX-p2.clientX, dy=p1.clientY-p2.clientY; return Math.hypot(dx,dy); }
  function mid(p1, p2){ return { x:(p1.clientX+p2.clientX)/2, y:(p1.clientY+p2.clientY)/2 }; }
  lbStage.addEventListener('touchstart', (e) => {
    if (!lightbox.classList.contains('open')) return;
    if (e.touches.length===1){ dragging=true; lastX=e.touches[0].clientX; lastY=e.touches[0].clientY; }
    if (e.touches.length===2){
      touchMode.active=true;
      const d = dist(e.touches[0], e.touches[1]);
      const m = mid(e.touches[0], e.touches[1]);
      const rect = lbStage.getBoundingClientRect();
      touchMode.startDist=d; touchMode.startScale=state.scale; touchMode.startTx=state.tx; touchMode.startTy=state.ty;
      touchMode.midX = m.x - rect.left; touchMode.midY = m.y - rect.top;
    }
  }, {passive:false});
  lbStage.addEventListener('touchmove', (e) => {
    if (!lightbox.classList.contains('open')) return;
    e.preventDefault();
    if (e.touches.length===1 && dragging){
      const t=e.touches[0]; const dx=t.clientX-lastX, dy=t.clientY-lastY; lastX=t.clientX; lastY=t.clientY;
      state.tx += dx; state.ty += dy; applyTransform();
    }
    if (e.touches.length===2 && touchMode.active){
      const d = dist(e.touches[0], e.touches[1]);
      const rect = lbStage.getBoundingClientRect();
      const m = mid(e.touches[0], e.touches[1]);
      let ns = clampScale(touchMode.startScale * (d / touchMode.startDist));
      const preX = touchMode.midX - state.tx, preY = touchMode.midY - state.ty;
      const ratio = ns / state.scale;
      state.scale = ns;
      state.tx = m.x - rect.left - preX * ratio;
      state.ty = m.y - rect.top  - preY * ratio;
      applyTransform();
    }
  }, {passive:false});
  lbStage.addEventListener('touchend', ()=>{ dragging=false; touchMode.active=false; }, {passive:true});

  // 双击切换 适配/100%
  lbStage.addEventListener('dblclick', () => {
    const targetIsFit = Math.abs(state.scale - state.fitScale) < 0.01;
    const target = targetIsFit ? 1 : state.fitScale;
    state.scale = clampScale(target);
    centerAtScale(state.scale);
    applyTransform();
  });

  // 控制按钮
  btnClose.addEventListener('click', closeLightbox);
  btnFit.addEventListener('click', () => {
    state.fitScale = computeFitScale();
    state.scale = state.fitScale; centerAtScale(state.scale); applyTransform();
  });
  btn100.addEventListener('click', () => {
    state.scale = clampScale(1); centerAtScale(state.scale); applyTransform();
  });
  btnZoomIn.addEventListener('click', () => { state.scale = clampScale(state.scale * 1.2); applyTransform(); });
  btnZoomOut.addEventListener('click', () => { state.scale = clampScale(state.scale / 1.2); applyTransform(); });

  // Esc 关闭、窗口变化重新适配
  document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeLightbox(); });
  window.addEventListener('resize', () => {
    if (!lightbox.classList.contains('open')) return;
    const wasFit = Math.abs(state.scale - state.fitScale) < 0.01;
    state.fitScale = computeFitScale();
    if (wasFit) {
      state.scale = state.fitScale; centerAtScale(state.scale);
    }
    applyTransform();
  });

  // 顶部导航
  backBtn.addEventListener('click', loadFolders);
  crumbHome.addEventListener('click', (e)=>{ e.preventDefault(); loadFolders(); });

  // 初始化
  loadFolders();
})();
</script>
</body>
</html>